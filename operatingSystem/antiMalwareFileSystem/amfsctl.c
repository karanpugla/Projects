#include"common.h"
#include<sys/types.h>
#include<sys/stat.h>
#include <fcntl.h>
#include<stdio.h>
#include<sys/ioctl.h>
#include<unistd.h>
#include<string.h>
#include<stdlib.h>
#include<errno.h>

void print_usage(void *);

int main(int argc, char * const argv[])
{
	amfs_allpatterns_t allpatt;
	amfs_pattern_t patt;
	int fd,i,rc,lflag,aflag,rflag;
	char c;
	
	
	opterr=0;
	lflag=aflag=rflag=0;
	while( (c=getopt(argc,argv,"la:r:h"))!= -1  )
	{
		if(lflag||aflag||rflag)
		print_usage("Only one option out of -l|-a|-r is allowed\n");
		
		switch(c)
		{
			case 'l':
			lflag=1;
			break;
			
			case 'a':
			aflag=1;
			strncpy(patt,optarg,256);
			patt[255]='\0';
			break;
			
			case 'r':
			rflag=1;
			strncpy(patt,optarg,256);
			patt[255]='\0';
			break;
			
			case 'h':
			print_usage(NULL);
			break;
			
			case '?':
			if( optopt=='a' )
			print_usage("Missing argument to -a.\n");
			else if( optopt=='r' )
			print_usage("Missing argument to -r.\n");
			else
			{
				printf("Unknown option '-%c'\n",optopt);
				print_usage(NULL);
			}
		}
	}
	if( !lflag && !aflag && !rflag)
	print_usage("Missing option.\n");
	if(optind < argc-1)
	print_usage("Extra number of arguments.\n");
	if(optind > argc-1)
	print_usage("Missing AMFS file parameter.\n");
	
	if( (fd=open(argv[optind],O_RDONLY))<0 )
	{
		print_usage("cannot open file in amfs.\n");
	}
	
	if(lflag)
	{
		if( (rc=ioctl(fd,AMFS_GETPATTERNS, &allpatt)) == 0 )
		{
			for(i=0;i<256;i++)
			{
				if(allpatt[i][0]!=-1)
				printf("pattern[%d] is %s\n",i,allpatt[i]);
			}
		}
		else
		{
			printf("error: ioctl returned %d\n",rc);
			perror(NULL);
			exit(1);
		}
	}
	else if(aflag)
	{
		if( (rc=ioctl(fd,AMFS_SETPATTERN, &patt)) == 0 )
		printf("pattern %s registered successfully.\n",patt);
		else
		{   printf("error: ioctl returned %d errno=%d\n",rc,errno);
			if(errno==EEXIST)
			printf("Pattern %s already resgistered\n",patt);
			else if (errno == ENOSPC)
				printf("No memory. Cannot register more than 256 patterns.\n");
			else
				perror(NULL);
			exit(1);
		}
	}
	else if(rflag)
	{
		if( (rc=ioctl(fd,AMFS_DELPATTERN, &patt)) == 0 )
		printf("pattern %s unregistered successfully.\n",patt);
		else
		{   printf("error: ioctl returned %d errno=%d\n",rc,errno);
			if(errno==ENOENT)
			printf("Pattern %s is not resgistered\n",patt);
			else
				perror(NULL);
			exit(1);
		}
	}
	return 0;
}

void print_usage(void* msg)
{
	if( msg!=NULL )
	printf("%s",(char *)msg);
	
	printf("USAGE: amfsctl [-l|-a <pattern>|-r <pattern>]  <path-to-amfs-mountpoint>\n\
	-l:           List all patterns currently registered in AMFS\n\
	-a <pattern>: Add a new pattern if it is not already registered\n\
	-r <pattern>: Remove a pattern if it is registered.\n\
	-h:           Show this help.\n");
		
		exit(1);
	}
	
